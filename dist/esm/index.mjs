import e from"fs";import s from"lodash";import r from"path";import o from"dotenv";import i from"events";import{TelegramClient as t}from"telegram";import{Logger as n}from"telegram/extensions/index.js";import{StringSession as m}from"telegram/sessions/index.js";o.config();const a=new n,p=new i,d=()=>new Promise((e=>{s.isEmpty(p.listeners("RequiresPhoneNumber"))&&(a.error("You need to set a listener on 'RequiresPhoneNumber' event"),process.exit(1)),p.emit("RequiresPhoneNumber",(s=>{a.info(`Phone number is '${s}'`),e(s)}))})),c=e=>new Promise((r=>{a.info("You will receive phone code via "+(e?"App":"SMS")),s.isEmpty(p.listeners("RequiresPhoneCode"))&&(a.error("You need to set a listener on 'RequiresPhoneCode' event"),process.exit(1)),p.emit("RequiresPhoneCode",(e=>{r(e)}))})),u=e=>new Promise((r=>{a.info(`The hint for your password is '${e}'`),s.isEmpty(p.listeners("RequiresPassword"))&&(a.error("You need to set a listener on 'RequiresPassword' event"),process.exit(1)),p.emit("RequiresPassword",(e=>{r(e)}))})),f=()=>new Promise((e=>{s.isEmpty(p.listeners("RequiresFirstAndLastNames"))&&(a.error("You need to set a listener on 'RequiresFirstAndLastNames' event"),process.exit(1)),p.emit("RequiresFirstAndLastNames",(([s,r])=>{a.info(`First name is '${s}'`),a.info(`Last name is '${r}'`),e([s,r])}))})),l=({message:e})=>{a.error(e),process.exit(1)},h=({apiId:o,apiHash:i,forceSMS:n=!1}={})=>{try{const h=r.resolve(".ptl.session"),P=new m(e.existsSync(h)?e.readFileSync(h,"utf8"):process.env.API_SESSION||""),v=new t(P,s.toNumber(o||process.env.API_ID),s.toString(i||process.env.API_HASH));return v.start({phoneNumber:d,phoneCode:c,password:u,firstAndLastNames:f,onError:l,forceSMS:n}).then((()=>e.promises.writeFile(h,v.session.save()))).then((()=>(a.info("Successfully connected and save session"),v.addEventHandler((e=>{p.emit(e.className,e)})),p))).catch((({message:e})=>{a.error(e),process.exit(1)}))}catch({message:e}){a.error(e),process.exit(1)}};export{p as eventEmitter,h as startSession};