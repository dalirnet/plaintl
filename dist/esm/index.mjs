import e from"fs";import s from"lodash";import r from"path";import o from"events";import i from"fs/promises";import{TelegramClient as t}from"telegram";import{parse as n,stringify as m}from"envfile";import{Logger as a}from"telegram/extensions/index.js";import{StringSession as p}from"telegram/sessions/index.js";const d=e=>s.trim(s.toString(e),["'",'"']),u=r.resolve("./.env"),f=n(e.existsSync(u)?e.readFileSync(u):""),c=new o,l=new a,h=()=>new Promise((e=>{s.isEmpty(c.listeners("RequiresPhoneNumber"))&&(l.error("You need to set a listener on 'RequiresPhoneNumber' event"),process.exit(1)),c.emit("RequiresPhoneNumber",(s=>{l.info(`Phone number is '${s}'`),e(s)}))})),P=e=>new Promise((r=>{l.info("You will receive phone code via "+(e?"App":"SMS")),s.isEmpty(c.listeners("RequiresPhoneCode"))&&(l.error("You need to set a listener on 'RequiresPhoneCode' event"),process.exit(1)),c.emit("RequiresPhoneCode",(e=>{r(e)}))})),S=e=>new Promise((r=>{l.info(`The hint for your password is '${e}'`),s.isEmpty(c.listeners("RequiresPassword"))&&(l.error("You need to set a listener on 'RequiresPassword' event"),process.exit(1)),c.emit("RequiresPassword",(e=>{r(e)}))})),v=()=>new Promise((e=>{s.isEmpty(c.listeners("RequiresFirstAndLastNames"))&&(l.error("You need to set a listener on 'RequiresFirstAndLastNames' event"),process.exit(1)),c.emit("RequiresFirstAndLastNames",(([s,r])=>{l.info(`First name is '${s}'`),l.info(`Last name is '${r}'`),e([s,r])}))})),w=({message:e})=>{l.error(e),process.exit(1)},x=(e=!1)=>{try{const r=s.toNumber(d(f.API_ID||process.env.API_ID)),o=d(f.API_HASH||process.env.API_HASH),n=new p(d(f.SESSION||"")),a=new t(n,r,o);return a.start({phoneNumber:h,phoneCode:P,password:S,firstAndLastNames:v,onError:w,forceSMS:e}).then((()=>i.writeFile(u,m({...f,SESSION:a.session.save()})))).then((()=>{l.info("Modified env file for next session"),l.info("Successfully connected")})).then((()=>{a.addEventHandler((e=>{c.emit(e.className,e)}))})).then((()=>c)).catch((({message:e})=>{l.error(e),process.exit(1)}))}catch({message:e}){l.error(e),process.exit(1)}};export{c as eventEmitter,x as startSession};