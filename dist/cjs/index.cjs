"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("fs"),s=require("lodash"),r=require("path"),t=require("events"),i=require("fs/promises"),n=require("telegram"),o=require("envfile"),a=require("telegram/extensions/index.js"),u=require("telegram/sessions/index.js");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=d(e),f=d(s),m=d(r),c=d(t),p=d(i);const h=e=>f.default.trim(f.default.toString(e),["'",'"']),q=m.default.resolve("./.env"),P=o.parse(l.default.existsSync(q)?l.default.readFileSync(q):""),v=new u.StringSession(h(P.SESSION||"")),S=f.default.toNumber(h(P.API_ID)),w=h(P.API_HASH),x=new c.default,g=new a.Logger,y=()=>new Promise((e=>{f.default.isEmpty(x.listeners("RequiresPhoneNumber"))&&(g.error("You need to set a listener on 'RequiresPhoneNumber' event"),process.exit(1)),x.emit("RequiresPhoneNumber",(s=>{g.info(`Phone number is '${s}'`),e(s)}))})),N=e=>new Promise((s=>{g.info("You will receive phone code via "+(e?"App":"SMS")),f.default.isEmpty(x.listeners("RequiresPhoneCode"))&&(g.error("You need to set a listener on 'RequiresPhoneCode' event"),process.exit(1)),x.emit("RequiresPhoneCode",(e=>{g.info(`Phone code is '${e}'`),s(e)}))})),R=e=>new Promise((s=>{g.info(`The hint for your password is '${e}'`),f.default.isEmpty(x.listeners("RequiresPassword"))&&(g.error("You need to set a listener on 'RequiresPassword' event"),process.exit(1)),x.emit("RequiresPassword",(e=>{g.info(`Phone code is '${e}'`),s(e)}))})),E=()=>new Promise((e=>{f.default.isEmpty(x.listeners("RequiresFirstAndLastNames"))&&(g.error("You need to set a listener on 'RequiresFirstAndLastNames' event"),process.exit(1)),x.emit("RequiresFirstAndLastNames",(([s,r])=>{g.info(`First name is '${s}'`),g.info(`Last name is '${r}'`),e([s,r])}))})),b=({message:e})=>{g.error(e),process.exit(1)};exports.eventEmitter=x,exports.start=(e=!1)=>{try{const s=new n.TelegramClient(v,S,w);return s.start({phoneNumber:y,phoneCode:N,password:R,firstAndLastNames:E,onError:b,forceSMS:e}).then((()=>p.default.writeFile(q,o.stringify({...P,SESSION:s.session.save()})))).then((()=>{g.info("Modified env file for next usage"),g.info("Successfully connected")})).then((()=>{s.addEventHandler((e=>{x.emit(e.className,e)}))})).then((()=>x)).catch((({message:e})=>{g.error(e),process.exit(1)}))}catch({message:e}){g.error(e),process.exit(1)}};