import e from"fs";import s from"lodash";import r from"path";import o from"dotenv";import n from"events";import{TelegramClient as i}from"telegram";import{Logger as t}from"telegram/extensions/index.js";import{StringSession as m}from"telegram/sessions/index.js";o.config();const a=new t,d=new n,p=(e,s)=>{a.error(s),e(new Error(s))},u=({apiId:o,apiHash:n,forceSMS:t=!1}={})=>new Promise(((u,l)=>{try{const c=r.resolve(".ptl.session"),f=new m(e.existsSync(c)?e.readFileSync(c,"utf8"):process.env.API_SESSION||""),h=new i(f,s.toNumber(o||process.env.API_ID),s.toString(n||process.env.API_HASH));return h.start({phoneNumber:()=>(e=>new Promise((r=>{s.isEmpty(d.listeners("RequiresPhoneNumber"))&&p(e,"You need to set a listener on 'RequiresPhoneNumber' event"),d.emit("RequiresPhoneNumber",(e=>{r(e)}))})))(l),phoneCode:e=>((e,r)=>new Promise((o=>{a.info("You will receive phone code via "+(r?"App":"SMS")),s.isEmpty(d.listeners("RequiresPhoneCode"))&&p(e,"You need to set a listener on 'RequiresPhoneCode' event"),d.emit("RequiresPhoneCode",(e=>{o(e)}))})))(l,e),password:e=>((e,r)=>new Promise((o=>{a.info(`The hint for your password is '${r}'`),s.isEmpty(d.listeners("RequiresPassword"))&&p(e,"You need to set a listener on 'RequiresPassword' event"),d.emit("RequiresPassword",(e=>{o(e)}))})))(l,e),firstAndLastNames:()=>(e=>new Promise((r=>{s.isEmpty(d.listeners("RequiresFirstAndLastNames"))&&p(e,"You need to set a listener on 'RequiresFirstAndLastNames' event"),d.emit("RequiresFirstAndLastNames",(([e,s])=>{a.info(`First name is '${e}'`),a.info(`Last name is '${s}'`),r([e,s])}))})))(l),onError:({message:e})=>{p(l,e)},forceSMS:t}).then((()=>e.promises.writeFile(c,h.session.save()))).then((()=>{a.info("Successfully connected and save session"),h.addEventHandler((e=>{d.emit(e.className,e)})),u(d)})).catch((({message:e})=>{p(l,e)}))}catch({message:e}){p(l,e)}}));export{d as eventEmitter,u as startSession};