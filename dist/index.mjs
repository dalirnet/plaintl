import e from"fs";import s from"lodash";import r from"path";import o from"dotenv";import n from"events";import{Logger as t,sessions as i,TelegramClient as m}from"telegram";export{Api}from"telegram";o.config();const a=new n,d=({apiId:o,apiHash:n,forceSMS:d=!1,logLevel:u="info"}={})=>{const p=new t(u),l=r.resolve(".ptl.session");return new Promise(((r,t)=>{try{const u=e=>{p.error(e),t(new Error(e))},c=new i.StringSession(e.existsSync(l)?e.readFileSync(l,"utf8"):process.env.API_SESSION||""),f=new m(c,s.toNumber(o||process.env.API_ID),s.toString(n||process.env.API_HASH),{baseLogger:p});return f.start({phoneNumber:()=>(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresPhoneNumber"))&&e("You need to set a listener on 'RequiresPhoneNumber' event"),a.emit("RequiresPhoneNumber",(e=>{r(e)}))})))(u),phoneCode:e=>(p.info("You will receive phone code via "+(e?"App":"SMS")),(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresPhoneCode"))&&e("You need to set a listener on 'RequiresPhoneCode' event"),a.emit("RequiresPhoneCode",(e=>{r(e)}))})))(u)),password:e=>(p.info(`The hint for your password is '${e}'`),(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresPassword"))&&e("You need to set a listener on 'RequiresPassword' event"),a.emit("RequiresPassword",(e=>{r(e)}))})))(u)),firstAndLastNames:()=>(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresFirstAndLastNames"))&&e("You need to set a listener on 'RequiresFirstAndLastNames' event"),a.emit("RequiresFirstAndLastNames",((e,s=null)=>{r([e,s])}))})))(u),onError:({message:e})=>{u(e)},forceSMS:d}).then((()=>e.promises.writeFile(l,f.session.save()))).then((()=>{p.info("Successfully connected and save session"),f.addEventHandler((e=>{a.emit(e.className,e)})),r(f)})).catch((({message:e})=>{u(t,e)}))}catch({message:e}){handleErrorAndReject(t,e)}}))};export{a as eventEmitter,d as startSession};