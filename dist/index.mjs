import e from"fs";import s from"lodash";import r from"path";import o from"dotenv";import n from"events";import{TelegramClient as t}from"telegram";import{Logger as i}from"telegram/extensions/index.js";import{StringSession as m}from"telegram/sessions/index.js";o.config();const a=new n,d=({apiId:o,apiHash:n,apiForceSMS:d=!1,logLevel:p="info"}={})=>{const u=new i(p),l=r.resolve(".ptl.session");return new Promise(((r,i)=>{try{const p=e=>{u.error(e),i(new Error(e))},c=new m(e.existsSync(l)?e.readFileSync(l,"utf8"):process.env.API_SESSION||""),f=new t(c,s.toNumber(o||process.env.API_ID),s.toString(n||process.env.API_HASH),{baseLogger:u});return f.start({phoneNumber:()=>(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresPhoneNumber"))&&e("You need to set a listener on 'RequiresPhoneNumber' event"),a.emit("RequiresPhoneNumber",(e=>{r(e)}))})))(p),phoneCode:e=>(u.info("You will receive phone code via "+(e?"App":"SMS")),(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresPhoneCode"))&&e("You need to set a listener on 'RequiresPhoneCode' event"),a.emit("RequiresPhoneCode",(e=>{r(e)}))})))(p)),password:e=>(u.info(`The hint for your password is '${e}'`),(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresPassword"))&&e("You need to set a listener on 'RequiresPassword' event"),a.emit("RequiresPassword",(e=>{r(e)}))})))(p)),firstAndLastNames:()=>(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresFirstAndLastNames"))&&e("You need to set a listener on 'RequiresFirstAndLastNames' event"),a.emit("RequiresFirstAndLastNames",((e,s=null)=>{r([e,s])}))})))(p),onError:({message:e})=>{p(e)},forceSMS:d}).then((()=>e.promises.writeFile(l,f.session.save()))).then((()=>{u.info("Successfully connected and save session"),f.addEventHandler((e=>{a.emit(e.className,e)})),r(f)})).catch((({message:e})=>{p(i,e)}))}catch({message:e}){handleErrorAndReject(i,e)}}))};export{a as eventEmitter,d as startSession};