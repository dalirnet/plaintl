import e from"fs";import s from"lodash";import r from"path";import o from"dotenv";import n from"events";import{TelegramClient as t}from"telegram";import{Logger as i}from"telegram/extensions/index.js";import{StringSession as m}from"telegram/sessions/index.js";o.config();const a=new n,d=new i,p=(e,s)=>{d.error(s),e(new Error(s))},u=({apiId:o,apiHash:n,apiForceSMS:u=!1,loggerLevel:l="info"}={})=>{i.setLevel(l);const c=r.resolve(".ptl.session");return new Promise(((r,i)=>{try{const l=new m(e.existsSync(c)?e.readFileSync(c,"utf8"):process.env.API_SESSION||""),f=new t(l,s.toNumber(o||process.env.API_ID),s.toString(n||process.env.API_HASH));return f.start({phoneNumber:()=>(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresPhoneNumber"))&&p(e,"You need to set a listener on 'RequiresPhoneNumber' event"),a.emit("RequiresPhoneNumber",(e=>{r(e)}))})))(i),phoneCode:e=>((e,r)=>new Promise((o=>{s.isEmpty(a.listeners("RequiresPhoneCode"))&&p(e,"You need to set a listener on 'RequiresPhoneCode' event"),d.info("You will receive phone code via "+(r?"App":"SMS")),a.emit("RequiresPhoneCode",(e=>{o(e)}))})))(i,e),password:e=>((e,r)=>new Promise((o=>{s.isEmpty(a.listeners("RequiresPassword"))&&p(e,"You need to set a listener on 'RequiresPassword' event"),d.info(`The hint for your password is '${r}'`),a.emit("RequiresPassword",(e=>{o(e)}))})))(i,e),firstAndLastNames:()=>(e=>new Promise((r=>{s.isEmpty(a.listeners("RequiresFirstAndLastNames"))&&p(e,"You need to set a listener on 'RequiresFirstAndLastNames' event"),a.emit("RequiresFirstAndLastNames",((e,s=null)=>{r([e,s])}))})))(i),onError:({message:e})=>{p(i,e)},forceSMS:u}).then((()=>e.promises.writeFile(c,f.session.save()))).then((()=>{d.info("Successfully connected and save session"),f.addEventHandler((e=>{a.emit(e.className,e)})),r(f)})).catch((({message:e})=>{p(i,e)}))}catch({message:e}){p(i,e)}}))};export{a as eventEmitter,u as startSession};